import{s as o}from"./index-DhOZtvq_.js";const l="entries",w="images",p=async r=>{const{data:e,error:t}=await o.rpc("get_email_by_username",{p_username:r});return{data:e,error:t}},_=async r=>{const{data:e,error:t}=await o.from("profiles").select("*").eq("id",r).single();return{data:e,error:t}},E=async(r,e)=>{const{data:t,error:s}=await o.from("profiles").update(e).eq("id",r).select();return{data:t,error:s}},q=async(r,e)=>{if(!r)return null;const t=r.name.split(".").pop(),s=`${e}/avatar.${t}`,{error:a}=await o.storage.from("avatars").upload(s,r,{upsert:!0});if(a)throw a;const{data:c}=o.storage.from("avatars").getPublicUrl(s);return c.publicUrl},D=async(r,e)=>{try{const{data:t,error:s}=await o.from(l).insert([{title:e.title,content:e.content,image_url:e.imageUrl,is_secret:e.isSecret,mood:e.mood,user_id:r,folder_id:e.folderId||null,date:e.date?new Date(e.date).toISOString():new Date().toISOString()}]).select();if(s)throw s;return t[0].id}catch(t){throw console.error("Error adding document: ",t),t}},y=async(r,e=!1,t=null,s=0,a=20,c=!1)=>{try{let n=o.from(l).select("*, folders(name, color)").eq("user_id",r);t&&(t==="Uncategorized"?n=n.is("folder_id",null):n=n.eq("folder_id",t)),c?n=n.eq("is_secret",!0):e||(n=n.eq("is_secret",!1)),n=n.order("is_favorite",{ascending:!1}).order("date",{ascending:!1}).range(s*a,(s+1)*a-1);const{data:f,error:u}=await n;if(u)throw u;return f.map(i=>({...i,id:i.id,imageUrl:i.image_url,isSecret:i.is_secret,habits:i.habits||{},folderId:i.folder_id,folder:i.folders,isFavorite:i.is_favorite,date:i.date?{toDate:()=>new Date(i.date)}:null}))}catch(n){throw console.error("Error getting documents: ",n),n}},b=async r=>{const{error:e}=await o.from(l).delete().eq("id",r);if(e)throw e},U=async(r,e)=>{if(!r)return null;const t=`${e}/${Date.now()}_${r.name}`,{error:s}=await o.storage.from(w).upload(t,r);if(s)throw s;return t},S=async r=>{if(!r)return null;const e="/storage/v1/object/public/images/";let t=r;if(r.includes(e)&&(t=r.split(e)[1]),r.startsWith("http")&&!r.includes("supabase"))return r;const{data:s,error:a}=await o.storage.from(w).createSignedUrl(t,3600);return a?(console.warn("Error signing URL:",a),null):s.signedUrl},v=async(r,e)=>{const{error:t}=await o.from(l).update({is_favorite:e}).eq("id",r);if(t)throw t},x=async(r,e)=>{const t={};e.title!==void 0&&(t.title=e.title),e.content!==void 0&&(t.content=e.content),e.mood!==void 0&&(t.mood=e.mood),e.folderId!==void 0&&(t.folder_id=e.folderId||null),e.date!==void 0&&(t.date=e.date);const{data:s,error:a}=await o.from(l).update(t).eq("id",r).select();if(a)throw a;return s[0]},P=async r=>{try{const{data:e,error:t}=await o.from(l).select("date").eq("user_id",r).order("date",{ascending:!1});if(t)throw t;const s=e.length;let a=0;const c=new Date;if(c.setHours(0,0,0,0),e.length>0){const n=new Date(e[0].date);n.setHours(0,0,0,0);const f=Math.abs(c-n);if(Math.ceil(f/(1e3*60*60*24))<=1){a=1;for(let d=0;d<e.length-1;d++){const i=new Date(e[d].date),g=new Date(e[d+1].date);i.setHours(0,0,0,0),g.setHours(0,0,0,0);const m=(i-g)/(1e3*60*60*24);if(m===1)a++;else if(m>1)break}}}return{totalEntries:s,streak:a}}catch(e){return console.error("Error getting stats:",e),{totalEntries:0,streak:0}}},I=async r=>{const{data:e,error:t}=await o.from("user_settings").select("secret_pin").eq("user_id",r).single();return t&&t.code!=="PGRST116"?(console.error("Error fetching PIN:",t),null):(e==null?void 0:e.secret_pin)||null},F=async(r,e)=>{const{error:t}=await o.from("user_settings").upsert({user_id:r,secret_pin:e});if(t)throw t},O=async(r,e,t="zinc",s=!1)=>{const{data:a,error:c}=await o.from("folders").insert([{user_id:r,name:e,color:t,is_secret:s}]).select().single();if(c)throw c;return a},$=async(r,e=!1)=>{const{data:t,error:s}=await o.from("folders").select("*").eq("user_id",r).eq("is_secret",e).order("name");if(s)throw s;return t},j=async r=>{const{error:e}=await o.from("folders").delete().eq("id",r);if(e)throw e},k=async r=>{try{const{data:e}=await _(r),t=await y(r,!0),{data:s}=await o.from("folders").select("*").eq("user_id",r);return{user:e,entries:t,folders:s||[],exportedAt:new Date().toISOString(),app:"Deep Dairy"}}catch(e){throw console.error("Export failed:",e),e}};export{p as a,$ as b,I as c,D as d,y as e,j as f,P as g,O as h,x as i,b as j,S as k,_ as l,E as m,q as n,k as o,F as s,v as t,U as u};
