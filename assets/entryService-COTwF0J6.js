import{s}from"./index-CC0qksji.js";const l="entries",g="images",y=async r=>{const{data:e,error:t}=await s.rpc("get_email_by_username",{p_username:r});return{data:e,error:t}},_=async r=>{const{data:e,error:t}=await s.from("profiles").select("*").eq("id",r).single();return{data:e,error:t}},E=async(r,e)=>{const{data:t,error:o}=await s.from("profiles").update(e).eq("id",r).select();return{data:t,error:o}},q=async(r,e)=>{if(!r)return null;const t=r.name.split(".").pop(),o=`${e}/avatar.${t}`,{error:a}=await s.storage.from("avatars").upload(o,r,{upsert:!0});if(a)throw a;const{data:c}=s.storage.from("avatars").getPublicUrl(o);return c.publicUrl},D=async(r,e)=>{try{const{data:t,error:o}=await s.from(l).insert([{title:e.title,content:e.content,image_url:e.imageUrl,is_secret:e.isSecret,mood:e.mood,user_id:r,folder_id:e.folderId||null,date:e.date?new Date(e.date).toISOString():new Date().toISOString()}]).select();if(o)throw o;return t[0].id}catch(t){throw console.error("Error adding document: ",t),t}},h=async(r,e=!1,t=null,o=0,a=20,c=!1)=>{try{let n=s.from(l).select("*, folders(name, color)").eq("user_id",r);t&&(t==="Uncategorized"?n=n.is("folder_id",null):n=n.eq("folder_id",t)),c?n=n.eq("is_secret",!0):e||(n=n.eq("is_secret",!1)),n=n.order("is_favorite",{ascending:!1}).order("date",{ascending:!1}).range(o*a,(o+1)*a-1);const{data:f,error:u}=await n;if(u)throw u;return f.map(i=>({...i,id:i.id,imageUrl:i.image_url,isSecret:i.is_secret,habits:i.habits||{},folderId:i.folder_id,folder:i.folders,isFavorite:i.is_favorite,date:i.date?{toDate:()=>new Date(i.date)}:null}))}catch(n){throw console.error("Error getting documents: ",n),n}},b=async r=>{const{error:e}=await s.from(l).delete().eq("id",r);if(e)throw e},U=async(r,e)=>{if(!r)return null;const t=`${e}/${Date.now()}_${r.name}`,{error:o}=await s.storage.from(g).upload(t,r);if(o)throw o;const{data:a}=s.storage.from(g).getPublicUrl(t);return a.publicUrl},v=async(r,e)=>{const{error:t}=await s.from(l).update({is_favorite:e}).eq("id",r);if(t)throw t},S=async(r,e)=>{const t={};e.title!==void 0&&(t.title=e.title),e.content!==void 0&&(t.content=e.content),e.mood!==void 0&&(t.mood=e.mood),e.folderId!==void 0&&(t.folder_id=e.folderId||null),e.date!==void 0&&(t.date=e.date);const{data:o,error:a}=await s.from(l).update(t).eq("id",r).select();if(a)throw a;return o[0]},x=async r=>{try{const{data:e,error:t}=await s.from(l).select("date").eq("user_id",r).order("date",{ascending:!1});if(t)throw t;const o=e.length;let a=0;const c=new Date;if(c.setHours(0,0,0,0),e.length>0){const n=new Date(e[0].date);n.setHours(0,0,0,0);const f=Math.abs(c-n);if(Math.ceil(f/(1e3*60*60*24))<=1){a=1;for(let d=0;d<e.length-1;d++){const i=new Date(e[d].date),m=new Date(e[d+1].date);i.setHours(0,0,0,0),m.setHours(0,0,0,0);const w=(i-m)/(1e3*60*60*24);if(w===1)a++;else if(w>1)break}}}return{totalEntries:o,streak:a}}catch(e){return console.error("Error getting stats:",e),{totalEntries:0,streak:0}}},P=async r=>{const{data:e,error:t}=await s.from("user_settings").select("secret_pin").eq("user_id",r).single();return t&&t.code!=="PGRST116"?(console.error("Error fetching PIN:",t),null):(e==null?void 0:e.secret_pin)||null},F=async(r,e)=>{const{error:t}=await s.from("user_settings").upsert({user_id:r,secret_pin:e});if(t)throw t},I=async(r,e,t="zinc",o=!1)=>{const{data:a,error:c}=await s.from("folders").insert([{user_id:r,name:e,color:t,is_secret:o}]).select().single();if(c)throw c;return a},O=async(r,e=!1)=>{const{data:t,error:o}=await s.from("folders").select("*").eq("user_id",r).eq("is_secret",e).order("name");if(o)throw o;return t},$=async r=>{const{error:e}=await s.from("folders").delete().eq("id",r);if(e)throw e},k=async r=>{try{const{data:e}=await _(r),t=await h(r,!0),{data:o}=await s.from("folders").select("*").eq("user_id",r);return{user:e,entries:t,folders:o||[],exportedAt:new Date().toISOString(),app:"Deep Dairy"}}catch(e){throw console.error("Export failed:",e),e}};export{y as a,O as b,P as c,D as d,h as e,$ as f,x as g,I as h,S as i,b as j,_ as k,E as l,q as m,k as n,F as s,v as t,U as u};
